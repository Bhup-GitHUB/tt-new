---
export interface Props {
  sheets: string[];
  classesBySheet: { [key: string]: string[] };
}

const { sheets, classesBySheet } = Astro.props;
---

<div class="max-w-2xl mx-auto">
  <div class="bg-gray-800 rounded-lg p-6 shadow-xl border border-gray-700">
    <form id="timetable-form" class="space-y-6">
      <div class="space-y-2">
        <label for="sheet-select" class="block text-lg font-medium text-gray-200">
          ğŸ“š Select Category (Branch)
        </label>
        <select
          id="sheet-select"
          name="sheet"
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"
          required
        >
          <option value="">-- Choose a Category --</option>
          {sheets.map(sheet => (
            <option value={sheet}>{sheet}</option>
          ))}
        </select>
      </div>

      <div class="space-y-2">
        <label for="class-select" class="block text-lg font-medium text-gray-200">
          ğŸ¯ Select Class (Section)
        </label>
        <select
          id="class-select"
          name="class"
          class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500"
          required
          disabled
        >
          <option value="">-- First Select a Category --</option>
        </select>
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <button
          type="submit"
          class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-all shadow-lg"
        >
          ğŸ” View Timetable
        </button>
        <button
          type="button"
          id="save-class-btn"
          class="flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-all shadow-lg"
        >
          ğŸ’¾ Save for Later
        </button>
      </div>
    </form>
  </div>

  <div id="saved-timetables" class="mt-8">
    <h3 class="text-xl font-semibold text-gray-200 mb-4 text-center">
      â­ Your Saved Timetables
    </h3>
    <div id="saved-list" class="space-y-2"></div>
    <div id="no-saved-message" class="text-center text-gray-400 py-4">
      No saved timetables yet. Save one to get started!
    </div>
  </div>
</div>

<script define:vars={{ classesBySheet }}>
  const form = document.getElementById('timetable-form');
  const sheetSelect = document.getElementById('sheet-select');
  const classSelect = document.getElementById('class-select');
  const saveBtn = document.getElementById('save-class-btn');
  const savedList = document.getElementById('saved-list');
  const noSavedMessage = document.getElementById('no-saved-message');

  sheetSelect.addEventListener('change', () => {
    const selectedSheet = sheetSelect.value;
    classSelect.innerHTML = '<option value="">-- Select a Class --</option>';

    if (selectedSheet && classesBySheet[selectedSheet]) {
      classesBySheet[selectedSheet].forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classSelect.appendChild(option);
      });
      classSelect.disabled = false;
    } else {
      classSelect.disabled = true;
    }
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const sheet = sheetSelect.value;
    const className = classSelect.value;

    if (!sheet || !className) {
      alert('âš ï¸ Please select both category and class');
      return;
    }

    window.location.href = `/timetable/${encodeURIComponent(sheet)}/${encodeURIComponent(className)}`;
  });

  saveBtn.addEventListener('click', () => {
    const sheet = sheetSelect.value;
    const className = classSelect.value;

    if (!sheet || !className) {
      alert('âš ï¸ Please select both category and class first');
      return;
    }

    const savedTimetables = JSON.parse(localStorage.getItem('savedTimetables') || '[]');
    const newEntry = {
      sheet,
      className,
      url: `/timetable/${encodeURIComponent(sheet)}/${encodeURIComponent(className)}`,
      timestamp: Date.now()
    };

    const filtered = savedTimetables.filter((item) =>
      !(item.sheet === sheet && item.className === className)
    );
    filtered.push(newEntry);

    if (filtered.length > 5) {
      filtered.shift();
    }

    localStorage.setItem('savedTimetables', JSON.stringify(filtered));
    renderSavedTimetables();
    
    saveBtn.textContent = 'âœ… Saved!';
    setTimeout(() => {
      saveBtn.textContent = 'ğŸ’¾ Save for Later';
    }, 2000);
  });

  function renderSavedTimetables() {
    const savedTimetables = JSON.parse(localStorage.getItem('savedTimetables') || '[]');
    savedList.innerHTML = '';

    if (savedTimetables.length === 0) {
      noSavedMessage.style.display = 'block';
      return;
    }

    noSavedMessage.style.display = 'none';

    savedTimetables.reverse().forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2';
      
      const link = document.createElement('a');
      link.href = item.url;
      link.textContent = `${item.sheet} - ${item.className}`;
      link.className = 'flex-1 p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-blue-400 hover:text-blue-300 transition-colors';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'ğŸ—‘ï¸';
      deleteBtn.className = 'px-3 py-3 bg-red-600 hover:bg-red-700 rounded-lg transition-colors';
      deleteBtn.onclick = () => deleteSaved(index);
      
      div.appendChild(link);
      div.appendChild(deleteBtn);
      savedList.appendChild(div);
    });
  }

  function deleteSaved(index) {
    const savedTimetables = JSON.parse(localStorage.getItem('savedTimetables') || '[]');
    savedTimetables.reverse().splice(index, 1);
    localStorage.setItem('savedTimetables', JSON.stringify(savedTimetables.reverse()));
    renderSavedTimetables();
  }

  renderSavedTimetables();
</script>