---
import Layout from '../../../layouts/Layout.astro';
import TimetableGrid from '../../../components/TimetableGrid.astro';
import timetableData from '../../../data/timetable.json';

export async function getStaticPaths() {
  const paths: { params: { sheet: string; class: string } }[] = [];

  Object.entries(timetableData).forEach(([sheetName, sheetData]) => {
    Object.keys(sheetData as any).forEach(className => {
      paths.push({
        params: {
          sheet: sheetName,
          class: className
        }
      });
    });
  });

  return paths;
}

const { sheet, class: className } = Astro.params;
const timetable = (timetableData as any)[sheet]?.[className];

if (!timetable) {
  throw new Error('Timetable not found');
}
---

<Layout title={`${className} Timetable - ${sheet}`}>
  <div class="text-center mb-8">
    <a href="/" class="inline-block text-blue-400 hover:text-blue-300 mb-6 text-lg font-medium transition-colors duration-200">
      ‚Üê Back to Home
    </a>
    <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-green-400 bg-clip-text text-transparent mb-4">
      {className}
    </h1>
    <p class="text-slate-300 text-xl font-medium">
      {sheet}
    </p>
  </div>

  <div class="flex flex-wrap justify-center gap-4 mb-8">
    <button
      id="save-png-btn"
      class="px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl font-semibold text-lg transform hover:scale-105"
    >
      Save as PNG
    </button>
    <button
      id="print-pdf-btn"
      class="px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl font-semibold text-lg transform hover:scale-105"
    >
      Print to PDF
    </button>
  </div>

  <TimetableGrid data={timetable} />

  <div class="mt-12 bg-slate-800/60 backdrop-blur-sm rounded-2xl p-6 inline-block mx-auto border border-slate-600/50 shadow-xl">
    <h3 class="text-xl font-bold text-slate-200 mb-4 text-center">Color Legend</h3>
    <div class="flex flex-wrap gap-6 text-base">
      <div class="flex items-center gap-3">
        <div class="w-5 h-5 bg-red-600 rounded-lg shadow-md"></div>
        <span class="text-slate-200 font-medium">Lecture</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="w-5 h-5 bg-blue-600 rounded-lg shadow-md"></div>
        <span class="text-slate-200 font-medium">Tutorial</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="w-5 h-5 bg-cyan-600 rounded-lg shadow-md"></div>
        <span class="text-slate-200 font-medium">Elective</span>
      </div>
      <div class="flex items-center gap-3">
        <div class="w-5 h-5 bg-green-600 rounded-lg shadow-md"></div>
        <span class="text-slate-200 font-medium">Free Time</span>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.getElementById('save-png-btn')?.addEventListener('click', async () => {
    const timetableElement = document.getElementById('timetable-grid');
    if (!timetableElement) return;

    try {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      document.head.appendChild(script);
      
      script.onload = async () => {
        const html2canvas = (window as any).html2canvas;
        const canvas = await html2canvas(timetableElement, {
          backgroundColor: null,
          scale: 2
        });

        const link = document.createElement('a');
        link.download = 'timetable.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      };
    } catch (error) {
      console.error('Error saving PNG:', error);
      alert('Error saving PNG. Please try again.');
    }
  });

  document.getElementById('print-pdf-btn')?.addEventListener('click', () => {
    window.print();
  });
</script>