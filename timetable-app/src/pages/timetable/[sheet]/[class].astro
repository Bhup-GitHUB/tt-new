---
import Layout from '../../../layouts/Layout.astro';
import TimetableGrid from '../../../components/TimetableGrid.astro';
import timetableData from '../../../data/timetable.json';

export async function getStaticPaths() {
  const paths: { params: { sheet: string; class: string } }[] = [];

  Object.entries(timetableData).forEach(([sheetName, sheetData]) => {
    Object.keys(sheetData as any).forEach(className => {
      paths.push({
        params: {
          sheet: sheetName,
          class: className
        }
      });
    });
  });

  return paths;
}

const { sheet, class: className } = Astro.params;
const timetable = (timetableData as any)[sheet]?.[className];

if (!timetable) {
  throw new Error('Timetable not found');
}
---

<Layout title={`${className} Timetable - ${sheet}`}>
  <div class="text-center mb-6">
    <a href="/" class="inline-block text-blue-400 hover:text-blue-300 mb-4">
      ‚Üê Back to Home
    </a>
    <h1 class="text-3xl md:text-4xl font-bold text-green-400 mb-2">
      {className}
    </h1>
    <p class="text-gray-300 text-lg">
      {sheet}
    </p>
  </div>

  <div class="flex flex-wrap justify-center gap-3 mb-6">
    <button
      id="save-png-btn"
      class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all shadow-lg font-medium"
    >
      Save as PNG
    </button>
    <button
      id="print-pdf-btn"
      class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all shadow-lg font-medium"
    >
      Print to PDF
    </button>
  </div>

  <TimetableGrid data={timetable} />

  <div class="mt-8 bg-gray-800 rounded-lg p-4 inline-block mx-auto">
    <h3 class="text-lg font-semibold text-gray-200 mb-2">Color Legend</h3>
    <div class="flex flex-wrap gap-4 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-red-600 rounded"></div>
        <span>Lecture</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-blue-600 rounded"></div>
        <span>Tutorial</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-cyan-600 rounded"></div>
        <span>Elective</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-green-600 rounded"></div>
        <span>Free Time</span>
      </div>
    </div>
  </div>
</Layout>

<script>
  document.getElementById('save-png-btn')?.addEventListener('click', async () => {
    const timetableElement = document.getElementById('timetable-grid');
    if (!timetableElement) return;

    try {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
      document.head.appendChild(script);
      
      script.onload = async () => {
        const html2canvas = (window as any).html2canvas;
        const canvas = await html2canvas(timetableElement, {
          backgroundColor: null,
          scale: 2
        });

        const link = document.createElement('a');
        link.download = 'timetable.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      };
    } catch (error) {
      console.error('Error saving PNG:', error);
      alert('Error saving PNG. Please try again.');
    }
  });

  document.getElementById('print-pdf-btn')?.addEventListener('click', () => {
    window.print();
  });
</script>